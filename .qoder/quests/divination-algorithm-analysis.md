# 算卦算法分析与设计文档

## 1. 概述

本文档旨在分析当前系统中实现的三种算卦算法：易经算卦、塔罗牌算卦和签诗算卦。通过详细分析，识别存在的问题并提供改进方案，确保算法的正确性和随机性。

## 2. 架构分析

### 2.1 整体架构
系统包含三种独立的算卦算法实现，每种算法封装在独立的TypeScript模块中，便于维护和扩展。

### 2.2 模块结构
- `iChing.ts`: 易经算卦算法实现
- `tarot.ts`: 塔罗牌算卦算法实现
- `qianShi.ts`: 签诗算卦算法实现

## 3. 算法实现分析

### 3.1 易经算卦算法 (iChing.ts)

#### 3.1.1 实现概述
易经算卦算法通过随机生成6个爻（每个爻为0或1）来形成卦象，然后查找对应的卦辞。

#### 3.1.2 数据结构
算法使用预定义的卦象数组，每个卦象包含：
- `name`: 卦名
- `hexagram`: 卦象符号（由"—"和"--"组成）
- `explanation`: 卦辞解释

#### 3.1.3 算法评估
该算法实现正确，能够生成有效的易经卦象，数据完整。

### 3.2 塔罗牌算卦算法 (tarot.ts)

#### 3.2.1 实现概述
塔罗牌算卦算法从78张塔罗牌中随机抽取指定数量的牌进行占卜。

#### 3.2.2 数据结构问题
发现数据结构不一致的问题：
- 大阿卡那牌包含`number`字段表示牌的编号
- 小阿卡那牌缺少`number`字段

#### 3.2.3 算法逻辑问题
存在"每次都是愚者"的问题，分析发现：
- 抽牌逻辑使用`slice(0, count)`直接取前几张牌
- 缺少洗牌过程，导致每次抽取的都是固定的牌

#### 3.2.4 改进方案
1. 统一数据结构：为所有塔罗牌添加`number`字段
2. 改进抽牌逻辑：实现洗牌算法后再抽取随机牌

### 3.3 签诗算卦算法 (qianShi.ts)

#### 3.3.1 实现概述
签诗算卦算法通过随机数选择一首签诗进行占卜。

#### 3.3.2 数据完整性问题
发现数据不完整的问题：
- 算法声称有100首签诗
- 实际只实现了28首签诗
- 缺少72首签诗内容

#### 3.3.3 改进方案
补充缺失的72首签诗，确保数据完整性。

## 4. 推荐改进措施

### 4.1 塔罗牌算法改进
1. 统一数据结构：
   - 为所有塔罗牌添加`number`字段
   - 确保大阿卡那牌和小阿卡那牌的数据结构一致

2. 改进抽牌逻辑：
   - 实现Fisher-Yates洗牌算法
   - 在抽牌前对牌组进行充分洗牌
   - 从洗牌后的牌组中随机抽取指定数量的牌

### 4.2 签诗算法改进
1. 数据补充：
   - 收集并添加缺失的72首签诗
   - 确保所有100首签诗的数据完整

2. 数据验证：
   - 添加数据完整性检查机制
   - 确保运行时签诗数量符合预期

### 4.3 易经算法维护
1. 当前实现正确，无需修改
2. 可考虑添加更多卦象解释的细节

## 5. 测试策略

### 5.1 单元测试
为每种算法编写单元测试，验证：
- 算法输出的正确性
- 随机性的合理性
- 边界条件的处理

### 5.2 集成测试
测试算法在实际应用中的表现：
- 大量调用后的分布均匀性
- 性能表现
- 异常处理能力

## 6. 实施计划

### 6.1 第一阶段：塔罗牌算法修复
1. 统一塔罗牌数据结构
2. 实现洗牌算法
3. 验证抽牌随机性

### 6.2 第二阶段：签诗算法完善
1. 补充缺失的签诗数据
2. 添加数据完整性验证
3. 验证算法正确性

### 6.3 第三阶段：整体测试
1. 编写完整的测试用例
2. 运行单元测试和集成测试
3. 验证所有算法的随机性和正确性